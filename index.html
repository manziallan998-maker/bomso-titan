<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOMSO · BILLAN ONLINE OFFICE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #0a0a0a;
            color: #eee;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #app {
            width: 1400px;
            max-width: 100%;
            background: #111;
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0,255,0,0.15), 0 0 30px #00ff8820;
            border: 1px solid #2a2a2a;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 800px;
        }

        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
        }
        .login-box {
            background: #1a1a1a;
            padding: 50px 40px;
            border-radius: 30px;
            width: 400px;
            max-width: 90%;
            border: 2px solid #00ff88;
            box-shadow: 0 10px 30px rgba(0,255,0,0.2);
        }
        .login-box h1 {
            color: #00ff88;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .login-box .sub {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
            font-size: 14px;
            letter-spacing: 2px;
        }
        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background: #111;
            border: 2px solid #333;
            border-radius: 15px;
            color: #00ff88;
            font-size: 16px;
            outline: none;
            transition: 0.2s;
        }
        .login-box input:focus {
            border-color: #00ff88;
        }
        .login-box button {
            width: 100%;
            padding: 15px;
            background: #00ff88;
            color: black;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .login-box button:hover {
            box-shadow: 0 0 20px #00ff88;
        }
        .login-box .error {
            color: #ff4d4d;
            margin-top: 15px;
            text-align: center;
        }

        .admin-layout {
            display: none;
            flex: 1;
            display: flex;
            min-height: 800px;
        }
        .sidebar {
            width: 280px;
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            padding: 30px 0;
        }
        .sidebar .logo {
            padding: 0 20px 30px 20px;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 30px;
        }
        .sidebar .logo h2 {
            color: #00ff88;
            font-size: 28px;
            letter-spacing: 2px;
        }
        .sidebar .logo p {
            color: #666;
            font-size: 12px;
        }
        .sidebar nav ul {
            list-style: none;
        }
        .sidebar nav li {
            padding: 15px 25px;
            margin: 5px 0;
            color: #aaa;
            cursor: pointer;
            transition: 0.2s;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sidebar nav li i {
            width: 24px;
            color: #00ff88;
        }
        .sidebar nav li:hover {
            background: #1a1a1a;
            color: #00ff88;
        }
        .sidebar nav li.active {
            background: #1a1a1a;
            color: #00ff88;
            border-left-color: #00ff88;
        }
        .main-content {
            flex: 1;
            background: #111;
            padding: 30px;
            overflow-y: auto;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #2a2a2a;
        }
        .main-header h1 {
            color: #00ff88;
            font-size: 28px;
        }
        .main-header .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #aaa;
        }
        .main-header button {
            background: #333;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
        }
        .main-header button:hover {
            background: #444;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 20px;
            border-left: 5px solid #00ff88;
        }
        .stat-card h3 {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            color: #00ff88;
            font-size: 32px;
            font-weight: bold;
        }

        .section-title {
            color: #00ff88;
            margin: 30px 0 20px;
            font-size: 22px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1a;
            border-radius: 20px;
            overflow: hidden;
        }
        th {
            background: #222;
            color: #00ff88;
            font-weight: 600;
            padding: 15px;
            text-align: left;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #2a2a2a;
            color: #ddd;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .badge {
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.active {
            background: #00ff8822;
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        .badge.expired {
            background: #ff4d4d22;
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
        }
        .badge.pending {
            background: #ffaa0022;
            color: #ffaa00;
            border: 1px solid #ffaa00;
        }
        button.approve {
            background: #00ff88;
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 5px;
        }
        button.reject {
            background: #ff4d4d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
        }
        button.enable {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
        }
        .add-form {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
        }
        .add-form h3 {
            color: #00ff88;
            margin-bottom: 20px;
        }
        .add-form input, .add-form select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #111;
            border: 2px solid #333;
            border-radius: 10px;
            color: #00ff88;
        }
        .add-form button {
            background: #00ff88;
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login view -->
        <div id="loginView" class="login-container">
            <div class="login-box">
                <h1>BOMSO</h1>
                <div class="sub">BILLAN ONLINE OFFICE</div>
                <input type="password" id="loginPassword" placeholder="Admin Password">
                <button onclick="login()">ENTER OFFICE</button>
                <div id="loginError" class="error"></div>
            </div>
        </div>

        <!-- Admin layout -->
        <div id="adminView" class="admin-layout" style="display: none;">
            <div class="sidebar">
                <div class="logo">
                    <h2>BOMSO</h2>
                    <p>BILLAN OFFICE</p>
                </div>
                <nav>
                    <ul>
                        <li id="navDashboard" class="active" onclick="switchView('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</li>
                        <li id="navOrganizations" onclick="switchView('organizations')"><i class="fas fa-building"></i> Organizations</li>
                        <li id="navRequests" onclick="switchView('requests')"><i class="fas fa-inbox"></i> Requests</li>
                        <li id="navSettings" onclick="switchView('settings')"><i class="fas fa-cog"></i> Settings</li>
                    </ul>
                </nav>
            </div>
            <div class="main-content" id="mainContent">
                <!-- dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const API_BASE = window.location.origin; // assumes API is on same origin

        // ==================== STATE ====================
        let authToken = localStorage.getItem('bomso_token'); // simple token after login
        let organizations = [];
        let pendingRequests = [];
        let currentView = 'dashboard';

        // ==================== API HELPERS ====================
        async function apiFetch(endpoint, options = {}) {
            const res = await fetch(API_BASE + endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authToken ? `Bearer ${authToken}` : '',
                    ...options.headers
                }
            });
            if (!res.ok) {
                const err = await res.text();
                throw new Error(err);
            }
            return res.json();
        }

        // ==================== AUTH ====================
        window.login = async function() {
            const pwd = document.getElementById('loginPassword').value;
            try {
                const data = await apiFetch('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ password: pwd })
                });
                authToken = data.token;
                localStorage.setItem('bomso_token', authToken);
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('adminView').style.display = 'flex';
                loadDashboardData();
            } catch (err) {
                document.getElementById('loginError').innerText = 'Invalid password';
            }
        };

        window.logout = function() {
            authToken = null;
            localStorage.removeItem('bomso_token');
            document.getElementById('loginView').style.display = 'flex';
            document.getElementById('adminView').style.display = 'none';
        };

        // ==================== DATA LOADING ====================
        async function loadDashboardData() {
            try {
                const [orgsRes, reqsRes] = await Promise.all([
                    apiFetch('/api/organizations'),
                    apiFetch('/api/requests?status=pending')
                ]);
                organizations = orgsRes;
                pendingRequests = reqsRes;
            } catch (err) {
                console.error('Failed to load data', err);
                // fallback to empty
                organizations = [];
                pendingRequests = [];
            }
            renderView(currentView);
        }

        // ==================== VIEW RENDERING ====================
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.sidebar nav li').forEach(li => li.classList.remove('active'));
            document.getElementById('nav' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
            renderView(view);
        }

        function renderView(view) {
            const main = document.getElementById('mainContent');
            if (view === 'dashboard') renderDashboard(main);
            else if (view === 'organizations') renderOrganizations(main);
            else if (view === 'requests') renderRequests(main);
            else if (view === 'settings') renderSettings(main);
        }

        function renderDashboard(container) {
            const activeOrgs = organizations.filter(o => o.subscription?.active).length;
            const totalOrgs = organizations.length;
            const pendingReqs = pendingRequests.length;
            const revenue = organizations.reduce((sum, o) => {
                if (o.subscription?.tier && o.subscription.tier !== 'trial') {
                    // rough estimate: assume each paid subscription contributes 100k
                    return sum + 100;
                }
                return sum;
            }, 0);
            container.innerHTML = `
                <div class="main-header">
                    <h1>Dashboard</h1>
                    <div class="user-info">
                        <span>Admin</span>
                        <button onclick="logout()">Logout</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><h3>TOTAL ORGANIZATIONS</h3><div class="value">${totalOrgs}</div></div>
                    <div class="stat-card"><h3>ACTIVE SUBSCRIPTIONS</h3><div class="value">${activeOrgs}</div></div>
                    <div class="stat-card"><h3>PENDING REQUESTS</h3><div class="value">${pendingReqs}</div></div>
                    <div class="stat-card"><h3>EST. REVENUE</h3><div class="value">${revenue}K RWF</div></div>
                </div>
                <h2 class="section-title">Recent Activity</h2>
                <table>
                    <thead><tr><th>Org</th><th>Action</th><th>Time</th></tr></thead>
                    <tbody>
                        ${pendingRequests.slice(0,5).map(req => `
                            <tr><td>${req.orgName}</td><td>Payment request (${req.selectedTier}m)</td><td>${new Date(req.timestamp).toLocaleString()}</td></tr>
                        `).join('')}
                        ${pendingRequests.length === 0 ? '<tr><td colspan="3">No recent activity</td></tr>' : ''}
                    </tbody>
                </table>
            `;
        }

        function renderOrganizations(container) {
            container.innerHTML = `
                <div class="main-header">
                    <h1>Organizations</h1>
                    <div class="user-info">
                        <span>Admin</span>
                        <button onclick="logout()">Logout</button>
                    </div>
                </div>
                <button onclick="showAddOrgForm()" style="background:#00ff88; color:black; border:none; padding:10px 20px; border-radius:30px; margin-bottom:20px; font-weight:bold; cursor:pointer;">+ Add Organization</button>
                <div id="addOrgForm" style="display:none;" class="add-form">
                    <h3>Add New Organization</h3>
                    <input type="text" id="newOrgCode" placeholder="Organization Code (unique)">
                    <input type="text" id="newOrgName" placeholder="Organization Name">
                    <input type="text" id="newOwner" placeholder="Owner Name">
                    <input type="text" id="newPhone" placeholder="Phone">
                    <input type="email" id="newEmail" placeholder="Email">
                    <input type="text" id="newUdc" placeholder="UDC (from BSMS)">
                    <button onclick="addOrganization()">Save Organization</button>
                </div>
                <table>
                    <thead><tr><th>Code</th><th>Name</th><th>Owner</th><th>Phone</th><th>Subscription</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${organizations.map(org => {
                            const sub = org.subscription || {};
                            const now = new Date();
                            const end = sub.endDate ? new Date(sub.endDate) : null;
                            const active = sub.active && end && end > now;
                            const status = active ? 'active' : 'inactive';
                            const endDate = end ? end.toLocaleDateString() : '—';
                            return `
                                <tr>
                                    <td>${org.orgCode}</td>
                                    <td>${org.orgName}</td>
                                    <td>${org.owner}</td>
                                    <td>${org.phone}</td>
                                    <td><span class="badge ${status === 'active' ? 'active' : 'expired'}">${status} ${status==='active' ? 'until '+endDate : ''}</span></td>
                                    <td>
                                        <button class="enable" onclick="enableContinue('${org.orgCode}')">Enable Continue</button>
                                        <button class="enable" style="background:#ffaa00;" onclick="extendSubscription('${org.orgCode}')">Extend</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderRequests(container) {
            // we need all requests, not just pending
            apiFetch('/api/requests').then(allReqs => {
                const pending = allReqs.filter(r => r.status === 'pending');
                const approved = allReqs.filter(r => r.status === 'approved');
                const rejected = allReqs.filter(r => r.status === 'rejected');
                container.innerHTML = `
                    <div class="main-header">
                        <h1>Payment Requests</h1>
                        <div class="user-info">
                            <span>Admin</span>
                            <button onclick="logout()">Logout</button>
                        </div>
                    </div>
                    <h2 class="section-title">Pending (${pending.length})</h2>
                    <table>
                        <thead><tr><th>Org</th><th>Owner</th><th>Phone</th><th>Plan</th><th>Amount</th><th>Time</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${pending.map(req => `
                                <tr>
                                    <td>${req.orgName} (${req.orgCode})</td>
                                    <td>${req.owner}</td>
                                    <td>${req.phone}</td>
                                    <td>${req.selectedTier === 0 ? 'Free Trial' : req.selectedTier+' months'}</td>
                                    <td>${req.selectedPrice?.toLocaleString() || 0} RWF</td>
                                    <td>${new Date(req.timestamp).toLocaleString()}</td>
                                    <td>
                                        <button class="approve" onclick="approveRequest('${req.id}')">Approve</button>
                                        <button class="reject" onclick="rejectRequest('${req.id}')">Reject</button>
                                    </td>
                                </tr>
                            `).join('')}
                            ${pending.length === 0 ? '<tr><td colspan="7">No pending requests</td></tr>' : ''}
                        </tbody>
                    </table>
                    <h2 class="section-title">Approved (${approved.length})</h2>
                    <table><thead><tr><th>Org</th><th>Plan</th><th>Approved Time</th></tr></thead><tbody>
                        ${approved.map(req => `<tr><td>${req.orgName}</td><td>${req.selectedTier}m</td><td>${new Date(req.approvedAt).toLocaleString()}</td></tr>`).join('')}
                        ${approved.length===0?'<tr><td colspan="3">None</td></tr>':''}
                    </tbody></table>
                `;
            }).catch(() => {
                container.innerHTML = '<p>Error loading requests</p>';
            });
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="main-header">
                    <h1>Settings</h1>
                    <div class="user-info">
                        <span>Admin</span>
                        <button onclick="logout()">Logout</button>
                    </div>
                </div>
                <div style="background:#1a1a1a; padding:30px; border-radius:20px;">
                    <h3 style="color:#00ff88;">Change Admin Password</h3>
                    <input type="password" id="currentPwd" placeholder="Current password" style="width:100%; padding:12px; margin-bottom:15px; background:#111; border:2px solid #333; border-radius:10px; color:#00ff88;">
                    <input type="password" id="newPwd" placeholder="New password" style="width:100%; padding:12px; margin-bottom:15px; background:#111; border:2px solid #333; border-radius:10px; color:#00ff88;">
                    <input type="password" id="confirmPwd" placeholder="Confirm new password" style="width:100%; padding:12px; margin-bottom:15px; background:#111; border:2px solid #333; border-radius:10px; color:#00ff88;">
                    <button onclick="changePassword()" style="background:#00ff88; color:black; border:none; padding:15px 30px; border-radius:30px; font-weight:bold; cursor:pointer;">Update Password</button>
                    <p id="pwdMsg" style="color:#ffaa00; margin-top:15px;"></p>
                </div>
                <div style="background:#1a1a1a; padding:30px; border-radius:20px; margin-top:30px;">
                    <h3 style="color:#00ff88;">Data Management</h3>
                    <button onclick="exportData()" style="background:#2196f3; color:white; border:none; padding:15px 30px; border-radius:30px; margin-right:10px; cursor:pointer;">Export All Data</button>
                    <button onclick="importData()" style="background:#ffaa00; color:black; border:none; padding:15px 30px; border-radius:30px; cursor:pointer;">Import Data</button>
                    <input type="file" id="importFile" style="display:none;" accept=".json" onchange="doImport()">
                </div>
            `;
        }

        // ==================== ACTIONS ====================
        window.showAddOrgForm = function() {
            document.getElementById('addOrgForm').style.display = 'block';
        };

        window.addOrganization = async function() {
            const orgCode = document.getElementById('newOrgCode').value;
            const orgName = document.getElementById('newOrgName').value;
            const owner = document.getElementById('newOwner').value;
            const phone = document.getElementById('newPhone').value;
            const email = document.getElementById('newEmail').value;
            const udc = document.getElementById('newUdc').value;
            if (!orgCode || !orgName || !owner || !phone) {
                alert('Please fill required fields');
                return;
            }
            try {
                await apiFetch('/api/organizations', {
                    method: 'POST',
                    body: JSON.stringify({ orgCode, orgName, owner, phone, email, udc })
                });
                alert('Organization added');
                document.getElementById('addOrgForm').style.display = 'none';
                // clear form
                document.getElementById('newOrgCode').value = '';
                document.getElementById('newOrgName').value = '';
                document.getElementById('newOwner').value = '';
                document.getElementById('newPhone').value = '';
                document.getElementById('newEmail').value = '';
                document.getElementById('newUdc').value = '';
                loadDashboardData();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        window.approveRequest = async function(requestId) {
            try {
                await apiFetch(`/api/requests/${requestId}/approve`, { method: 'POST' });
                alert('Request approved');
                loadDashboardData();
                // also refresh requests view if open
                if (currentView === 'requests') renderView('requests');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        window.rejectRequest = async function(requestId) {
            try {
                await apiFetch(`/api/requests/${requestId}/reject`, { method: 'POST' });
                alert('Request rejected');
                loadDashboardData();
                if (currentView === 'requests') renderView('requests');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        window.enableContinue = async function(orgCode) {
            try {
                await apiFetch(`/api/organizations/${orgCode}/enable`, { method: 'POST' });
                alert('Continue button enabled');
                loadDashboardData();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        window.extendSubscription = async function(orgCode) {
            try {
                await apiFetch(`/api/organizations/${orgCode}/extend`, { method: 'POST' });
                alert('Subscription extended by 1 month');
                loadDashboardData();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        window.changePassword = async function() {
            const current = document.getElementById('currentPwd').value;
            const newPwd = document.getElementById('newPwd').value;
            const confirm = document.getElementById('confirmPwd').value;
            if (newPwd !== confirm) {
                document.getElementById('pwdMsg').innerText = 'New passwords do not match';
                return;
            }
            try {
                await apiFetch('/api/settings/password', {
                    method: 'POST',
                    body: JSON.stringify({ current, new: newPwd })
                });
                document.getElementById('pwdMsg').innerText = 'Password changed successfully';
            } catch (err) {
                document.getElementById('pwdMsg').innerText = 'Error: ' + err.message;
            }
        };

        window.exportData = function() {
            window.location.href = API_BASE + '/api/export';
        };

        window.importData = function() {
            document.getElementById('importFile').click();
        };

        window.doImport = async function() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch(API_BASE + '/api/import', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });
                if (!res.ok) throw new Error('Import failed');
                alert('Data imported successfully');
                loadDashboardData();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        // ==================== INIT ====================
        if (authToken) {
            // try to auto-login
            (async () => {
                try {
                    await apiFetch('/api/verify'); // simple endpoint to check token
                    document.getElementById('loginView').style.display = 'none';
                    document.getElementById('adminView').style.display = 'flex';
                    loadDashboardData();
                } catch {
                    localStorage.removeItem('bomso_token');
                    authToken = null;
                }
            })();
        }
    </script>
</body>
</html>